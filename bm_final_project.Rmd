---
title: "bm_final_project"
author: "kindle zhang"
date: "2023-12-06"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: "show"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(survminer)
library(survival)
library(ggplot2)
library(My.stepwise)
library(corrr)
library(gtools)
library(corrplot)
library(car)
library(factoextra)
library(data.table)
library(rms)
library(performance)
library(regplot)
library(glmnet)
library(caret)
library(ResourceSelection)
library(MASS)
library(cowplot)
library(pROC)
```

# clean the data

```{r}
heart_df = 
  read_csv("./Project_2_data.csv") |> 
  janitor::clean_names() |> 
  relocate(survival_months, status) |> 
  mutate(
    race = as.numeric(factor(race, levels = c("White", "Black", "Other"))),
    marital_status = as.numeric(factor(marital_status, levels = c("Married", "Divorced", "Single", "Widowed", "Separated"))),
    t_stage = as.numeric(factor(t_stage, levels = c("T1", "T2", "T3", "T4"))),
    n_stage = as.numeric(factor(n_stage, levels = c("N1", "N2", "N3"))),
    x6th_stage = as.numeric(factor(x6th_stage, levels = c("IIA", "IIIA", "IIIC", "IIB", "IIIB"))),
    differentiate = as.numeric(factor(differentiate, levels = c("Poorly differentiated", "Moderately differentiated", "Well differentiated", "Undifferentiated"))),
    grade = as.numeric(factor(grade, levels = c("3", "2", "1", "anaplastic; Grade IV"))),
    a_stage = as.numeric(factor(a_stage, levels = c("Regional", "Distant"))),
    estrogen_status = as.numeric(factor(estrogen_status, levels = c("Positive", "Negative"))),
    progesterone_status = as.numeric(factor(progesterone_status, levels = c("Positive", "Negative"))),
    status = as.numeric(factor(status, levels = c("Alive", "Dead")))
  ) |> 
  rename(ms = "marital_status", 
         t_s = "t_stage",
         n_s = "n_stage",
         x6_s = "x6th_stage",
         a_s = "a_stage",
         diff = "differentiate",
         est = "estrogen_status",
         pro = "progesterone_status",
         rne = "regional_node_examined",
         rnp = "reginol_node_positive"
         )

variablesummary = 
  lapply(heart_df[,3:16], table)
```

<font color = "blue">1. outcome: 1 continuous; 1 binary
2. predictors: 4 continuous; 10 categorical</font>


# examine predictors 

## for categorical variable

### graphic plot

```{r}
# Histograms for each categorical variables
par(mfrow=c(1,2))
hist(heart_df$status, main='status')
hist(heart_df$race, main='race')
hist(heart_df$ms, main='ms')
hist(heart_df$t_s, main='t_s')
hist(heart_df$n_s, main='n_s')
hist(heart_df$x6_s, main='x6_s')
hist(heart_df$a_s, main='a_s')
hist(heart_df$diff, main='diff')
hist(heart_df$grade, main='grade')
hist(heart_df$est, main='est')
hist(heart_df$est, main='pro')
```

<font color = "blue">1, tumor, rne, rnp significant right-skewed. 2, some categorical variable has powerful correlation.</font>

### char-squared

```{r}
heart_df_2 = 
  read_csv("./Project_2_data.csv") |> 
  janitor::clean_names() |> 
  relocate(survival_months, status) |> 
  dplyr::select("race", "marital_status", "t_stage", "n_stage", "x6th_stage", "differentiate", "grade", "a_stage", "estrogen_status", "progesterone_status") |> 
  mutate_all(as.factor)

result_table = 
  data.frame(Variable1 = character(), 
             Variable2 = character(), 
             ChiSquare = numeric(), 
             PValue = numeric(), 
             stringsAsFactors = TRUE)


for (col1 in names(heart_df_2)[1:(ncol(heart_df_2) - 1)]) {
  for (col2 in names(heart_df_2)[(match(col1, names(heart_df_2)) + 1):ncol(heart_df_2)]) {
    
    contingency_table <- table(heart_df_2[[col1]], heart_df_2[[col2]])

    
    chi_sq_test_result <- chisq.test(contingency_table,
                                     correct = T)

    
    variable1 <- col1
    variable2 <- col2
    chi_square <- chi_sq_test_result$statistic
    p_value <- chi_sq_test_result$p.value

    
    result_table <- rbind(result_table, data.frame(variable1, variable2, chi_square, p_value))
  }
}

original_row_names = rownames(result_table)
new_row_names <- as.character(1:nrow(result_table))
rownames(result_table) <- new_row_names

result_table = 
  result_table |> 
  arrange(desc(p_value))

result_table
```

<font color = "blue">particularly, difference and grade should preserve one. delete `differentiate`. What's more, delete `n_stage`, `est`, `t_stage`</font>

## for continuous variable

### graphic plot

```{r}
# Boxplots for each continuous variable
par(mfrow=c(2,3))
boxplot(heart_df$survival_months, main='survival_months')
boxplot(heart_df$age, main='age')
boxplot(heart_df$tumor_size, main='tumor_size')
boxplot(heart_df$rne, main='rne')
boxplot(heart_df$rnp, main='rnp')
```

```{r}
p1 =ggplot(heart_df, aes(x = survival_months)) + geom_density()
p2 = ggplot(heart_df, aes(x = age)) + geom_density()
p3 = ggplot(heart_df, aes(x = tumor_size)) + geom_density()
p4 = ggplot(heart_df, aes(x = rne)) + geom_density()
p5 = ggplot(heart_df, aes(x = rnp)) + geom_density()

combined_plot = plot_grid(p1, p2, p3, p4, p5, 
                           ncol = 3,
                           nrow = 2)
combined_plot
```

### Rank-sum test and t-test

```{r}
result1 = t.test(age ~ status, data = heart_df)
result2 = wilcox.test(tumor_size ~ status, data = heart_df)
result3 = wilcox.test(rne ~ status, data = heart_df)
result4 = wilcox.test(rnp ~ status, data = heart_df)
```

<font color = "blue">delete `rne`</font>

## correlation for remaining variables 

```{r}
par(mfrow = c(1, 1), mar = c(5, 4, 4, 2) + 0.1)
cor_cate = cor(heart_df[,c(2, 3:5, 8, 10:12, 14, 16)])

corrplot(cor_cate, type = "upper", diag = FALSE, mar = c(0, 0, 0, 0))
```

<font color = "blue"> There is no apparent linear correlation among variables </font>

## check the dataset again

```{r}
heart_df_log = 
  read_csv("./Project_2_data.csv") |> 
  janitor::clean_names() |> 
  relocate(survival_months, status) |> 
  mutate(
    race = factor(race, levels = c("White", "Black", "Other")),
    marital_status = factor(marital_status, levels = c("Married", "Divorced", "Single", "Widowed", "Separated")),
    x6th_stage = factor(x6th_stage, levels = c("IIA", "IIIA", "IIIC", "IIB", "IIIB")),
    grade = factor(grade, levels = c("3", "2", "1", "anaplastic; Grade IV")),
    a_stage = factor(a_stage, levels = c("Regional", "Distant")),
    progesterone_status = factor(progesterone_status, levels = c("Positive", "Negative")),
    status = factor(status, levels = c("Alive", "Dead"))) |> 
  dplyr::select(-survival_months, -differentiate, -n_stage, -t_stage, -estrogen_status, -regional_node_examined)

summary(heart_df_log)
str(heart_df_log)
```

### examine interaction 

```{r}
glm_result_1 = glm(data = heart_df_log,
                 status ~ a_stage * reginol_node_positive,
                 binomial(link = 'logit'))
broom::tidy(glm_result)
```

<font color = "blue">I check all the 2 variable group to find whether there exists a correlation effect, and find a_stage and reginol_node_positive's interaction p-value is 1.37e-4, which means there interaction event play a vital role in our model. </font>

# model variable select

## 1. stepwise

### build model

```{r}
model = 
  glm(status ~ . + a_stage * reginol_node_positive, 
      data = heart_df_log, 
      family = binomial(link = 'logit'))

summary(model)

model_step = step(model, direction = "both")

summary(model_step)
```

<font color = "blue"> preserve all the variable.</font>

### the model

```{r}
formula1 = 
  as.formula(
  status ~ age + race + marital_status + x6th_stage + grade + a_stage + tumor_size + progesterone_status + reginol_node_positive + a_stage * reginol_node_positive)

model = glm(formula1, 
            data = heart_df_log, 
            family = binomial(link = 'logit'))

summary(model)
check_collinearity(model)
```

## random forest

### build model

```{r}
library(randomForest)
set.seed(123)
model = 
  randomForest(status~. + a_stage * reginol_node_positive, data = heart_df_log)

summary(model)

plot(model)

forest_min = which.min(model$err.rate[,1])
```

```{r}
model_forest = 
  randomForest(status~. + a_stage * reginol_node_positive, 
               data = heart_df_log, 
               ntree = forest_min, 
               mtry = 4)

model_forest
```

```{r}
importance(model_forest)
varImpPlot(model_forest)
```

### the model

```{r}
formula2 = 
  as.formula(
  status ~ tumor_size + age + reginol_node_positive + marital_status + x6th_stage + grade)

model = glm(formula2, 
            data = heart_df_log, 
            family = binomial(link = 'logit'))

summary(model)
check_collinearity(model)
```

according to the picture, I find the first 6 most important variables have a mean decrease gini over 50, which is significantly larger than other variables, so I use these variables to build my final model.

## LASSO

### build model

```{r}
x = as.matrix(heart_df_log[,2:9])
y = as.matrix(heart_df_log[,1])
```
```{r}
model_lasso =
  glmnet(x, y, alpha = 1, family = "binomial")

model_lasso
```
lambda = 0.001546 only 2 predictors were preserved

```{r}
plot(lasso, xvar = "lambda", label = TRUE)

lasso.coef = coef(lasso, s = 0.001546)
lasso.coef
```

```{r}
lambdas = seq(0, 0.5, length.out = 200)
cv.lasso = 
  cv.glmnet(x, 
            y, 
            alpha = 1,
            lambda = lambdas,
            nfolds = 5,
            family = "binomial")

par(mfrow = c(1, 1), mar = c(5, 5, 4, 2) + 0.1)
plot(cv.lasso, 
     main = "Cross-Validation Paths", 
     cex.lab = 1.2, cex.main = 1.2)

plot(cv.lasso$glmnet.fit, 
     xvar = "lambda",
     label = T)

lasso_1se =
  cv.lasso$lambda.1se
lasso_1se

lasso.coef = 
  coef(cv.lasso$glmnet.fit,
       s = lasso_1se,
       exact = F)
lasso.coef
```

### model

```{r}
formula3 = 
  as.formula(
  status ~ tumor_size)

model = glm(formula3, 
            data = heart_df_log, 
            family = binomial(link = 'logit'))

summary(model)
# check_collinearity(model)
```

# nomogram

```{r}
dd = datadist(heart_df_log)
options(datadist = "dd")

nomogram_plot = function(input){
  nomo_plot = 
    regplot(input,
            observation = heart_df_log[1,],
            center = TRUE,
            title = "Nomogram",
            points = TRUE,
            odds = FALSE,
            showP = TRUE,
            rank= "sd",
            clickable = FALSE)
}
```

```{r}
fit1 = lrm(formula1, data = heart_df_log)
fit2 = lrm(formula2, data = heart_df_log)
fit3 = lrm(formula3, data = heart_df_log)

nomogram_plot(fit1)
nomogram_plot(fit2)
nomogram_plot(fit3)
```

#ROC and AUC

```{r}
fit1 = lrm(formula1, 
           data = heart_df_log,
           x = T,
           y = T)

# AUC
cal_auc = function(input){
  heart_df_log$predvalue1 = predict(input)
  ROC = roc(heart_df_log$status, 
            heart_df_log$predvalue1)
  round(auc(ROC),3)
  round(ci(auc(ROC)),3)

  plot(1 - ROC$specificities,
       ROC$sensitivities,
       type = "l",
       col = "red",
       lty = 1,
       xlab = "FP",
       ylab = "TP",
       lwd = 2,
       axes = TRUE,
       xlim = c(0, 1))
  abline(0,1)
  legend(0.55, 0.35,
        c(input),
        lty = c(1),
        lwd = c(2),
        col = c("red"),
        bty = "n")
}

cal_auc(fit1) + cal_auc(fit2) + cal_auc(fit3)
```

# 拟合优度检验H-L

```{r}
# fit1 = glm(formula1, 
#            data = heart_df_log,
#            family = binomial(link = logit))
hl1 = hoslem.test(fit1$y, fitted(fit1), g = 10)
hl2 = hoslem.test(fit2$y, fitted(fit2), g = 10)

hl1
## X-squared = 8.8156, df = 8, p-value = 0.3581
```

# validation(标准化数据怎么弄)

```{r}
train = 
  trainControl(method = "cv", number = 5)

model_caret = 
  train(status ~ tumor_size + reginol_node_positive,
                   data = heart_df_log,
                   trControl = train,
                   method = "glm",
                   na.action = na.pass)

model_caret$finalModel
print(model_caret)

model_caret_2 = 
  train(formula1,
        data = heart_df_log,
        trControl = train,
        method = "glm",
        na.action = na.pass)

model_caret_2$finalModel
print(model_caret_2)
```


# form
h1


# interpretation
log(p/(1-p))= 

