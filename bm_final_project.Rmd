---
title: "bm_final_project"
author: "kindle zhang"
date: "2023-12-06"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: "show"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(survminer)
library(survival)
library(ggplot2)
library(My.stepwise)
library(corrr)
library(gtools)
library(corrplot)
library(car)
library(factoextra)
library(data.table)
library(rms)
library(performance)
library(regplot)
library(glmnet)
library(caret)
library(ResourceSelection)
library(MASS)
library(cowplot)
```

# clean the data

```{r}
heart_df = 
  read_csv("./Project_2_data.csv") |> 
  janitor::clean_names() |> 
  relocate(survival_months, status) |> 
  mutate(
    race = as.numeric(factor(race, levels = c("White", "Black", "Other"))),
    marital_status = as.numeric(factor(marital_status, levels = c("Married", "Divorced", "Single", "Widowed", "Separated"))),
    t_stage = as.numeric(factor(t_stage, levels = c("T1", "T2", "T3", "T4"))),
    n_stage = as.numeric(factor(n_stage, levels = c("N1", "N2", "N3"))),
    x6th_stage = as.numeric(factor(x6th_stage, levels = c("IIA", "IIIA", "IIIC", "IIB", "IIIB"))),
    differentiate = as.numeric(factor(differentiate, levels = c("Poorly differentiated", "Moderately differentiated", "Well differentiated", "Undifferentiated"))),
    grade = as.numeric(factor(grade, levels = c("3", "2", "1", "anaplastic; Grade IV"))),
    a_stage = as.numeric(factor(a_stage, levels = c("Regional", "Distant"))),
    estrogen_status = as.numeric(factor(estrogen_status, levels = c("Positive", "Negative"))),
    progesterone_status = as.numeric(factor(progesterone_status, levels = c("Positive", "Negative"))),
    status = as.numeric(factor(status, levels = c("Alive", "Dead")))
  ) |> 
  rename(ms = "marital_status", 
         t_s = "t_stage",
         n_s = "n_stage",
         x6_s = "x6th_stage",
         a_s = "a_stage",
         diff = "differentiate",
         est = "estrogen_status",
         pro = "progesterone_status",
         rne = "regional_node_examined",
         rnp = "reginol_node_positive"
         )

variablesummary = 
  lapply(heart_df[,3:16], table)
```

<font color = "blue">1. outcome: 1 continuous; 1 binary
2. predictors: 4 continuous; 10 categorical</font>



# examine predictors 

```{r}
# Boxplots for each continuous variable
par(mfrow=c(2,3))
boxplot(heart_df$survival_months, main='survival_months')
boxplot(heart_df$age, main='age')
boxplot(heart_df$tumor_size, main='tumor_size')
boxplot(heart_df$rne, main='rne')
boxplot(heart_df$rnp, main='rnp')

# Histograms for each categorical variables
par(mfrow=c(1,2))
hist(heart_df$status, main='status')
hist(heart_df$race, main='race')
hist(heart_df$ms, main='ms')
hist(heart_df$t_s, main='t_s')
hist(heart_df$n_s, main='n_s')
hist(heart_df$x6_s, main='x6_s')
hist(heart_df$a_s, main='a_s')
hist(heart_df$grade, main='grade')
hist(heart_df$est, main='est')
hist(heart_df$est, main='pro')

```

<font color = "blue">1, tumor, rne, rnp significant right-skewed. 2, some categorical variable has powerful correlation.</font>

# transform by boxcox

```{r}
# density for continuous variables

# heart_df |> 
#   mutate(lnsurvival = log(rnp)) |> 
#   ggplot(aes(x = survival_months))+geom_density()
p1 =ggplot(heart_df, aes(x = survival_months)) + geom_density()
p2 = ggplot(heart_df, aes(x = age)) + geom_density()
p3 = ggplot(heart_df, aes(x = tumor_size)) + geom_density()
p4 = ggplot(heart_df, aes(x = rne)) + geom_density()
p5 = ggplot(heart_df, aes(x = rnp)) + geom_density()

combined_plot = plot_grid(p1, p2, p3, p4, p5, 
                           ncol = 3,
                           nrow = 2)
combined_plot
```

```{r}
transformed_data = boxcox(heart_df$)$x
lambda_value <- boxcox(original_data + 1)$lambda
```


# examie interaction 

## correlation

```{r}
par()
cor(heart_df[,3:16])
corrplot(cor(heart_df[,3:16]), type = "upper", diag = FALSE, mar = c(0, 0, 0, 0))
par(mfrow = c(1, 1), mar = c(5, 4, 4, 2) + 0.1)
```

<font color = "blue">diff & grade, n_s & rnp, t_s & tumor_size, t_s & x6_s, est & pro have the strongest correlation, particularly, difference and grade should preserve one</font>


## char-squared

```{r}
heart_df_2 = 
  read_csv("../hw/data_file/Project_2_data.csv") |> 
  janitor::clean_names() |> 
  relocate(survival_months, status) |> 
  dplyr::select("race", "marital_status", "t_stage", "n_stage", "x6th_stage", "grade", "a_stage", "estrogen_status", "progesterone_status") |> 
  mutate_all(as.factor)

result_table = 
  data.frame(Variable1 = character(), 
             Variable2 = character(), 
             ChiSquare = numeric(), 
             PValue = numeric(), 
             stringsAsFactors = TRUE)


for (col1 in names(heart_df_2)[1:(ncol(heart_df_2) - 1)]) {
  for (col2 in names(heart_df_2)[(match(col1, names(heart_df_2)) + 1):ncol(heart_df_2)]) {
    
    contingency_table <- table(heart_df_2[[col1]], heart_df_2[[col2]])

    
    chi_sq_test_result <- chisq.test(contingency_table,
                                     correct = T)

    
    variable1 <- col1
    variable2 <- col2
    chi_square <- chi_sq_test_result$statistic
    p_value <- chi_sq_test_result$p.value

    
    result_table <- rbind(result_table, data.frame(variable1, variable2, chi_square, p_value))
  }
}

original_row_names = rownames(result_table)
new_row_names <- as.character(1:nrow(result_table))
rownames(result_table) <- new_row_names

result_table = 
  result_table |> 
  arrange(desc(p_value))

result_table
```

## one-way anova

```{r}
set.seed(123)

heart_df_3 = 
  read_csv("../hw/data_file/Project_2_data.csv") |> 
  janitor::clean_names() |> 
  relocate(survival_months, status) |> 
  dplyr::select("status", "age", "tumor_size", "regional_node_examined", "reginol_node_positive")


anova_results = list()

for(i in 2:ncol(heart_df_3)){
  formula_obj <- as.formula(paste(names(heart_df_3)[i], "~ status", sep = ""))
  anova_result <- aov(formula_obj, data = heart_df_3)
  
  p_value = summary(anova_result)[[1]]["Pr(>F)"]["status",]
 
  anova_results[[i - 1]] <- p_value
}

anova_tb = 
  tibble(
    variale = c("age", "tumor_size", "regional_node_examined", "reginol_node_positive"),
    p_value = anova_results
  ) |> 
  unnest(p_value)

anova_tb
heart_df_log |> 
  count(grade)
```

# model select

## check the data

```{r}
heart_df_log = 
  read_csv("../hw/data_file/Project_2_data.csv") |> 
  janitor::clean_names() |> 
  relocate(survival_months, status) |> 
  mutate(
    race = factor(race, levels = c("White", "Black", "Other")),
    marital_status = factor(marital_status, levels = c("Married", "Divorced", "Single", "Widowed", "Separated")),
    t_stage = factor(t_stage, levels = c("T1", "T2", "T3", "T4")),
    n_stage = factor(n_stage, levels = c("N1", "N2", "N3")),
    x6th_stage = factor(x6th_stage, levels = c("IIA", "IIIA", "IIIC", "IIB", "IIIB")),
    differentiate = factor(differentiate, levels = c("Poorly differentiated", "Moderately differentiated", "Well differentiated", "Undifferentiated")),
    grade = factor(grade, levels = c("3", "2", "1", "anaplastic; Grade IV")),
    a_stage = factor(a_stage, levels = c("Regional", "Distant")),
    estrogen_status = factor(estrogen_status, levels = c("Positive", "Negative")),
    progesterone_status = factor(progesterone_status, levels = c("Positive", "Negative")),
    status = factor(status, levels = c("Alive", "Dead"))) |> 
  # mutate(
  #   status = ifelse(status == "Alive", 1, 0),
  #   a_stage = ifelse(a_stage == "Regional", 1, 0),
  #   estrogen_status = ifelse(estrogen_status == "Positive", 1, 0),
  #   progesterone_status = ifelse(progesterone_status == "Positive", 1, 0)
  # ) |> 
  select(-survival_months, -differentiate)

summary(heart_df_log)
str(heart_df_log)
```

```{r}
par(mfrow = c(1,2))
qqnorm(heart_df_log$age, main = "age")
qqline(heart_df_log$age, col = 2)
qqnorm(heart_df_log$tumor_size, main = "tumor_size")
qqline(heart_df_log$tumor_size, col = 2)
qqnorm(heart_df_log$regional_node_examined, main = "regional_node_examined")
qqline(heart_df_log$regional_node_examined, col = 2)
qqnorm(heart_df_log$reginol_node_positive, main = "reginol_node_positive")
qqline(heart_df_log$reginol_node_positive, col = 2)
```

<font color = "blue">most continuous data are right skewed, we can use a log function to make it more close to normal distribution </font>


```{r}
# heart_df_log = 
#   heart_df_log |> 
#     mutate(
#       log_size = log(tumor_size),
#       log_node_ex = log(regional_node_examined),
#       log_node_po = log(reginol_node_positive)
#     )
# 
# qqnorm(heart_df_log$log_node_po, main = "log_node_po")
# qqline(heart_df_log$log_node_po, col = 2)
```



## t test & char squared

```{r}
x2 = c("race", "marital_status", "t_stage", "n_stage", "x6th_stage", "grade", "a_stage", "estrogen_status", "progesterone_status")

x1 = c("age", "tumor_size", "regional_node_examined", "reginol_node_positive")

library(tableone)
table1 = CreateTableOne(
  vars = c(x1, x2),
  data = heart_df_log,
  factorVars = x2,
  strata = "status",
  addOverall = FALSE)


results1 = print(table1, showAllLevels = FALSE)

knitr::kable(results1[,c(3)], align = 'c',
      caption = 'Table 1')
```

<font color = "blue">`regional_node_examined` is not a very good data，but we can preserve it</font>

--------------------------------------------
## stepwise

### select

```{r}
model = 
  glm(status ~ ., data = heart_df_log, family = binomial(link = 'logit'))

summary(model)

step_model = step(model, direction = "both")

summary(step_model)
```

<font color = "blue">1. grade level4 is not a good data, delete this level 2. delete tumor_size, marital_status, x6th_stage, a_stage, t_stage </font>

### the model

```{r}
# heart_df_log =
#   heart_df_log |>
#     filter(!grade %in% "anaplastic; Grade IV")
```

```{r}
formula1 = 
  as.formula(
  status ~ age + race + n_stage + grade + estrogen_status + progesterone_status + regional_node_examined + reginol_node_positive)

model = glm(formula1, data = heart_df_log, family = binomial(link = 'logit'))

summary(model)
check_collinearity(model)
```


## random forest

### select

```{r}
library(randomForest)
set.seed(123)
model = 
  randomForest(status~., data = heart_df_log)
model

plot(model)

which.min(model$err.rate[,1])
```

```{r}
model2 = randomForest(status~., data = heart_df_log, ntree = 233, mtry = 4)
model2
```

```{r}
importance(model2)
varImpPlot(model2)
```

### the model

## LASSO

### select

```{r}
# corrlate = cor(as.matrix(heart_df))
# corrplot.mixed(corrlate)

x = as.matrix(heart_df_log[,2:14])
y = as.matrix(heart_df_log[,1])
```
```{r}
lasso =
  glmnet(x, y, alpha = 1, family = "binomial")

lasso
```
lambda = 0.000882 only 3 predictors were preserved

```{r}
plot(lasso, xvar = "lambda", label = TRUE)

lasso.coef = coef(lasso, s = 0.000882)
lasso.coef
```

```{r}
lambdas = seq(0, 0.5, length.out = 200)
set.seed(123)
cv.lasso = 
  cv.glmnet(x, 
            y, 
            alpha = 1,
            lambda = lambdas,
            nfolds = 5,
            family = "binomial")

par(mfrow = c(1, 1), mar = c(5, 5, 4, 2) + 0.1)
plot(cv.lasso, 
     main = "Cross-Validation Paths", 
     cex.lab = 1.2, cex.main = 1.2)

plot(cv.lasso$glmnet.fit, 
     xvar = "lambda",
     label = T)

lasso_1se =
  cv.lasso$lambda.1se
lasso_1se

lasso.coef = 
  coef(cv.lasso$glmnet.fit,
       s = lasso_1se,
       exact = F)
lasso.coef
```


### model

```{r}
model = 
  glm(status ~ tumor_size + reginol_node_positive, data = heart_df_log, family = binomial())
summary(model)
```


# nomogram

```{r}
dd = datadist(heart_df_log)
options(datadist = "dd")
```

```{r}
fit1 = 
  lrm(formula1, data = heart_df_log)

nom1 = 
  regplot(fit1,
          observation = heart_df_log[80,],
          center = TRUE,
          title = "Nomogram",
          points = TRUE,
          odds = FALSE,
          showP = TRUE,
          rank= "sd",
          clickable = FALSE)

```

#ROC and AUC

```{r}
fit1 = lrm(formula1, 
           data = heart_df_log,
           x = T,
           y = T)

# AUC
heart_df_log$predvalue1 = predict(fit1)
library(pROC)
ROC1 = roc(heart_df_log$status, 
           heart_df_log$predvalue1)
round(auc(ROC1),3)
round(ci(auc(ROC1)),3)
# 0.746
```

```{r}
par(mfrow=c(1,1))
plot(1 - ROC1$specificities,
     ROC1$sensitivities,
     type = "l",
     col = "red",
     lty = 1,
     xlab = "FP",
     ylab = "TP",
     lwd = 2,
     axes = TRUE,
     xlim = c(0, 1))
abline(0,1)
legend(0.55, 0.35,
      c("fit1"),
      lty = c(1),
      lwd = c(2),
      col = c("red"),
      bty = "n")
```


# 拟合优度检验H-L

```{r}
fit1 = glm(formula1, 
           data = heart_df_log,
           family = binomial(link = logit))
hl1 = hoslem.test(fit1$y, fitted(fit1), g = 10)

hl1
## X-squared = 8.8156, df = 8, p-value = 0.3581
```

# validation(标准化数据怎么弄)

```{r}
train = 
  trainControl(method = "cv", number = 5)

model_caret = 
  train(status ~ tumor_size + reginol_node_positive,
                   data = heart_df_log,
                   trControl = train,
                   method = "glm",
                   na.action = na.pass)

model_caret$finalModel
print(model_caret)

model_caret_2 = 
  train(formula1,
        data = heart_df_log,
        trControl = train,
        method = "glm",
        na.action = na.pass)

model_caret_2$finalModel
print(model_caret_2)
```